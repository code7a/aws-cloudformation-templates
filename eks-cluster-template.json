{
    "Resources":{
        "Bucket":{
            "Type":"AWS::S3::Bucket"
        },
        "InternetGateway":{
            "Type":"AWS::EC2::InternetGateway"
        },
        "VPC":{
            "Type":"AWS::EC2::VPC",
            "Properties":{
                "CidrBlock":"10.0.0.0/16",
                "EnableDnsHostnames":"true"
            },
            "DependsOn":"InternetGateway"
        },
        "FlowLog":{
            "Type":"AWS::EC2::FlowLog",
            "Properties":{
                "LogDestination":{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"Bucket"}]]},
                "LogDestinationType":"s3",
                "ResourceId":{"Ref":"VPC"},
                "ResourceType":"VPC",
                "TrafficType":"ALL"
            },
            "DependsOn":["Bucket","VPC"]
        },
        "VPCGatewayAttachment":{
            "Type":"AWS::EC2::VPCGatewayAttachment",
            "Properties":{
                "InternetGatewayId":{"Ref":"InternetGateway"},
                "VpcId":{"Ref":"VPC"}
            },
            "DependsOn":"VPC"
        },
        "RouteTable":{
            "Type":"AWS::EC2::RouteTable",
            "Properties":{
                "VpcId":{"Ref":"VPC"}
            },
            "DependsOn":"VPCGatewayAttachment"
        },
        "Route":{
            "Type":"AWS::EC2::Route",
            "Properties":{
                "DestinationCidrBlock":"0.0.0.0/0",
                "GatewayId":{"Ref":"InternetGateway"},
                "RouteTableId":{"Ref":"RouteTable"}
            },
            "DependsOn":"RouteTable"
        },
        "SubnetA":{
            "Type":"AWS::EC2::Subnet",
            "Properties":{
                "CidrBlock":"10.0.0.0/20",
                "AvailabilityZone":{"Fn::Join":["",[{"Ref":"AWS::Region"},"a"]]},
                "MapPublicIpOnLaunch":"true",
                "VpcId":{"Ref":"VPC"}
            },
            "DependsOn":"VPC"
        },
        "SubnetB":{
            "Type":"AWS::EC2::Subnet",
            "Properties":{
                "CidrBlock":"10.0.16.0/20",
                "AvailabilityZone":{"Fn::Join":["",[{"Ref":"AWS::Region"},"b"]]},
                "MapPublicIpOnLaunch":"true",
                "VpcId":{"Ref":"VPC"}
            },
            "DependsOn":"SubnetA"
        },
        "SubnetARouteTableAssociation":{
            "Type":"AWS::EC2::SubnetRouteTableAssociation",
            "Properties":{
                "RouteTableId":{"Ref":"RouteTable"},
                "SubnetId":{"Ref":"SubnetA"}
            },
            "DependsOn":"SubnetA"
        },
        "SubnetBRouteTableAssociation":{
            "Type":"AWS::EC2::SubnetRouteTableAssociation",
            "Properties":{
                "RouteTableId":{"Ref":"RouteTable"},
                "SubnetId":{"Ref":"SubnetB"}
            },
            "DependsOn":"SubnetB"
        },
        "EKSClusterRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "AssumeRolePolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[{
                        "Effect":"Allow",
                        "Principal":{"Service":"eks.amazonaws.com"},
                        "Action":"sts:AssumeRole"
                    }]
                },
                "Policies":[
                    {
                        "PolicyName":"EKSClusterPolicy",
                        "PolicyDocument":{
                            "Version":"2012-10-17",
                            "Statement":[
                                {
                                    "Effect":"Allow",
                                    "Action":["ec2:CreateTags"],
                                    "Resource":"arn:aws:ec2:*:*:instance/*",
                                    "Condition":{"ForAnyValue:StringLike":{"aws:TagKeys":"kubernetes.io/cluster/*"}}
                                },
                                {
                                    "Effect":"Allow",
                                    "Action":[
                                        "ec2:DescribeInstances",
                                        "ec2:DescribeNetworkInterfaces",
                                        "ec2:DescribeVpcs",
                                        "ec2:DescribeDhcpOptions",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource":"*"
                                }
                            ]
                        }
                    }
                ],
                "RoleName":"EKSClusterRole"
            },
            "DependsOn":"SubnetB"
        },
        "EKSCluster":{
            "Type":"AWS::EKS::Cluster",
            "Properties":{
                "ResourcesVpcConfig":{
                    "SubnetIds":[ {"Ref":"SubnetA"},{"Ref":"SubnetB"} ]
                },
                "RoleArn":{ "Fn::GetAtt":["EKSClusterRole","Arn"]}
            },
            "DependsOn":"EKSClusterRole"
        },
        "EKSNodeRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "AssumeRolePolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Principal":{"Service":"ec2.amazonaws.com"},
                            "Action":"sts:AssumeRole"
                        }
                    ]
                },
                "Policies":[
                    {
                        "PolicyName":"EC2ContainerRegistryReadOnly",
                        "PolicyDocument":{
                            "Version":"2012-10-17",
                            "Statement":[
                                {
                                    "Effect":"Allow",
                                    "Action":[
                                        "ecr:GetAuthorizationToken",
                                        "ecr:BatchCheckLayerAvailability",
                                        "ecr:GetDownloadUrlForLayer",
                                        "ecr:GetRepositoryPolicy",
                                        "ecr:DescribeRepositories",
                                        "ecr:ListImages",
                                        "ecr:DescribeImages",
                                        "ecr:BatchGetImage",
                                        "ecr:GetLifecyclePolicy",
                                        "ecr:GetLifecyclePolicyPreview",
                                        "ecr:ListTagsForResource",
                                        "ecr:DescribeImageScanFindings"
                                    ],
                                    "Resource":"*"
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName":"EKSWorkerNodePolicy",
                        "PolicyDocument":{
                            "Version":"2012-10-17",
                            "Statement":[
                                {
                                    "Sid":"WorkerNodePermissions",
                                    "Effect":"Allow",
                                    "Action":[
                                        "ec2:DescribeInstances",
                                        "ec2:DescribeInstanceTypes",
                                        "ec2:DescribeRouteTables",
                                        "ec2:DescribeSecurityGroups",
                                        "ec2:DescribeSubnets",
                                        "ec2:DescribeVolumes",
                                        "ec2:DescribeVolumesModifications",
                                        "ec2:DescribeVpcs",
                                        "eks:DescribeCluster",
                                        "eks-auth:AssumeRoleForPodIdentity"
                                    ],
                                    "Resource":"*"
                                }
                            ]
                        }
                    },
                    {
                    "PolicyName":"EKSCNIPolicy",
                        "PolicyDocument":{
                            "Version":"2012-10-17",
                            "Statement":[
                              {
                                "Effect":"Allow",
                                "Action":[
                                  "ec2:AssignPrivateIpAddresses",
                                  "ec2:AttachNetworkInterface",
                                  "ec2:CreateNetworkInterface",
                                  "ec2:DeleteNetworkInterface",
                                  "ec2:DescribeInstances",
                                  "ec2:DescribeTags",
                                  "ec2:DescribeNetworkInterfaces",
                                  "ec2:DescribeInstanceTypes",
                                  "ec2:DetachNetworkInterface",
                                  "ec2:ModifyNetworkInterfaceAttribute",
                                  "ec2:UnassignPrivateIpAddresses"
                                ],
                                "Resource":"*"
                              },
                              {
                                "Effect":"Allow",
                                "Action":["ec2:CreateTags"],
                                "Resource":["arn:aws:ec2:*:*:network-interface/*"]
                              }
                            ]
                          }
                    }
                ],
                "RoleName":"EKSNodeRole"
            },
            "DependsOn":"EKSCluster"
        },
        "EKSNodegroup":{
            "Type":"AWS::EKS::Nodegroup",
            "Properties":{
                "ClusterName":{"Ref":"EKSCluster"},
                "NodeRole":{ "Fn::GetAtt":["EKSNodeRole","Arn"]},
                "Subnets":[{"Ref":"SubnetA"},{"Ref":"SubnetB"}]
            },
            "DependsOn":"EKSNodeRole"
        }
    }
}